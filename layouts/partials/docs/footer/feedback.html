{{ if eq .Site.Params.feedback.emoticonTpl true }}
{{ $emoticons := slice "very_satisfied" "satisfied" "dissatisfied" "very_dissatisfied" }}
<div class="container d-flex align-items-center justify-content-center">
    <div id="feedback-widget-emoticon" class="mt-4">
        <div id="feedback-cta" class="d-flex justify-content-center py-1">
            <span class="fs-6 align-self-center ms-2 me-0">
                {{ i18n "feedback_helpful" | default "Was this page helpful?" }}
            </span>
            <div class="d-flex">
                <div class="form-emoji d-flex ps-2">
                    {{ range $index, $value := $emoticons }}
                    <div class="radio-emoji">
                        <input type="radio" name="feedback-emoticon" autocomplete="off"
                            value="{{ $value | humanize | title }}" id="radio_{{ $index }}" required>
                        <label class="d-flex justify-content-center align-items-center" for="radio_{{ $index }}">
                            {{ $emoticon := resources.Get (printf "images/icons/feedback/%s.svg" $value) }}
                            {{ if $emoticon }}
                            {{ $emoticon.Content | safeHTML }}
                            {{ else }}
                            <span aria-label="{{ $value | humanize }}">[{{ $value | humanize }}]</span>
                            {{ end }}
                        </label>
                    </div>
                    {{ end }}
                </div>
            </div>
        </div>

        <div id="feedback-emoji-end" class="d-flex justify-content-md-start justify-content-sm-center"></div>

        <div id="feedback-send" class="d-none">
            <div id="text-wrapper">
                <textarea id="textarea-emoji" cols="55" maxlength="500" rows="3"
                    placeholder="(Optional) Try to be as specific and detailed as possible!"
                    class="feedback-textarea-emoji p-2 mb-2"></textarea>
            </div>
            <div id="feedback-emoji-submit-container" class="d-flex justify-content-end">
                <button type="button" id="feedback-emoji-submit-button"
                    class="feedback-submit-emoji-btn btn btn-sm btn-primary mt-1 mb-2" disabled>
                    {{ i18n "feedback_submit" | default "Submit" }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const emojiRadios = document.querySelectorAll('input[name="feedback-emoticon"]');
        const emojiContainer = document.getElementById("feedback-widget-emoticon");
        const feedbackCta = document.getElementById("feedback-cta");
        const feedbackSend = document.getElementById("feedback-send");
        const submitBtn = document.getElementById("feedback-emoji-submit-button");

        // Show textarea when an emoji is selected
        emojiRadios.forEach(radio => {
            radio.addEventListener("change", () => {
                emojiContainer.style.borderRadius = "8px";
                feedbackCta.classList.add("px-4");
                feedbackSend.classList.remove("d-none");
                submitBtn.removeAttribute("disabled");
            });
        });

        // Handle emoji feedback submission
        submitBtn.addEventListener("click", () => {
            const rating = document.querySelector('input[name="feedback-emoticon"]:checked')?.value;
            const message = document.getElementById("textarea-emoji").value;
            const resultEl = document.getElementById("feedback-emoji-end");

            function onSuccess() {
                document.getElementById("feedback-cta").remove();
                feedbackSend.remove();
                resultEl.innerHTML = `{{ .Site.Params.feedback.successMsg | default "Thank you for helping to improve our documentation!" }}`;
                resultEl.classList.add("is-visible", "text-success", "fw-bold");
            }

            try {
                { { if .Site.Config.Services.GoogleAnalytics.ID } }
                { { if not.Site.Params.feedback.eventDest | or(in .Site.Params.feedback.eventDest "google") } }
                gtag("event", "{{ .Site.Params.feedback.emoticonEventName | default "feedback" | lower | replaceRE `( +)` "_" }}", {
                    rating: rating?.replace(/\s+/g, "_").toLowerCase(),
                    message,
                    event_callback: onSuccess
                });
                { { end } }
                { { end } }

                { { if .Site.Params.plausible.dataDomain } }
                { { if not.Site.Params.feedback.eventDest | or(in .Site.Params.feedback.eventDest "plausible") } }
                plausible("{{ .Site.Params.feedback.emoticonEventName | default "Feedback" }}", {
                    callback: onSuccess,
                    props: { rating, message }
                });
                { { end } }
                { { end } }

                // Fallback if no analytics
                if (!window.gtag && !window.plausible) {
                    console.log("No analytics provider found. Simulating success.");
                    onSuccess();
                }
            } catch (err) {
                console.error("Feedback submission failed:", err);
                document.getElementById("feedback-cta").remove();
                feedbackSend.remove();
                resultEl.innerHTML = `{{ .Site.Params.feedback.errorMsg | default "Sorry! There was an error submitting your feedback." }}`;
                resultEl.classList.add("is-visible", "text-danger", "fw-bold");
            }
        });
    });
</script>

{{ else }}
<div id="feedback-widget" class="feedback-container pt-4">
    <div id="feedback-init" class="d-flex justify-content-md-start justify-content-sm-center">
        <span class="fs-5 fw-bold me-2">{{ i18n "feedback_helpful" | default "Was this page helpful?" }}</span>
        <div class="d-flex">
            <button id="posBtn" class="feedback-btn btn btn-primary btn-sm me-2" type="button">
                <span class="fs-6">
                    <i class="material-icons me-1 align-middle" aria-hidden="true">thumb_up</i>
                    {{ i18n "feedback_yes" | default "Yes" }}
                </span>
            </button>
            <button id="negBtn" class="feedback-btn btn btn-primary btn-sm me-2" type="button">
                <span class="fs-6">
                    <i class="material-icons me-1 align-middle" aria-hidden="true">thumb_down</i>
                    {{ i18n "feedback_no" | default "No" }}
                </span>
            </button>
        </div>
    </div>

    <div id="feedback-end" class="d-flex justify-content-md-start justify-content-sm-center fs-4 fw-bold me-2"></div>

    <div id="feedback-form-pos" data-type="positive"
        class="feedback-form justify-content-md-start justify-content-sm-center d-none">
        <p class="fw-bold fs-5">{{ .Site.Params.feedback.positiveFormTitle | default "What did you like?" }}</p>
        {{ range $index, $value := .Site.Params.feedback.positiveForm }}
        {{ $rating := index $value 0 }}
        {{ $description := index $value 1 }}
        <div class="form-check pb-1">
            <input class="form-check-input" type="radio" name="feedback" value="{{ $rating | lower }}"
                id="radio{{ $index }}Pos" required>
            <label class="form-check-label" for="radio{{ $index }}Pos">
                {{ $rating }}
                {{ if $description }}
                <p class="feedback-radio-desc fw-normal mb-0">{{ $description }}</p>
                {{ end }}
            </label>
        </div>
        <div id="radio{{ $index }}PosTextContainer" class="feedback-textarea-container"></div>
        {{ end }}
    </div>

    <div id="feedback-form-neg" data-type="negative" class="feedback-form justify-content-sm-center d-none">
        <p class="fw-bold fs-5">{{ .Site.Params.feedback.negativeFormTitle | default "What went wrong?" }}</p>
        {{ range $index, $value := .Site.Params.feedback.negativeForm }}
        {{ $rating := index $value 0 }}
        {{ $description := index $value 1 }}
        <div class="form-check pb-1">
            <input class="form-check-input" type="radio" name="feedback" value="{{ $rating | lower }}"
                id="radio{{ $index }}Neg" required>
            <label class="form-check-label" for="radio{{ $index }}Neg">
                {{ $rating }}
                {{ if $description }}
                <p class="feedback-radio-desc fw-normal mb-0">{{ $description }}</p>
                {{ end }}
            </label>
        </div>
        <div id="radio{{ $index }}NegTextContainer" class="feedback-textarea-container"></div>
        {{ end }}
    </div>

    <div id="feedback-submit-container" class="d-none">
        <button id="feedback-submit-button" class="feedback-submit-btn btn btn-primary mt-3" type="button" disabled>
            <span class="fs-6">{{ i18n "feedback_submit" | default "Submit" }}</span>
        </button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const posBtn = document.getElementById("posBtn");
        const negBtn = document.getElementById("negBtn");
        const feedbackInit = document.getElementById("feedback-init");
        const feedbackFormPos = document.getElementById("feedback-form-pos");
        const feedbackFormNeg = document.getElementById("feedback-form-neg");
        const feedbackSubmitContainer = document.getElementById("feedback-submit-container");
        const feedbackSubmitBtn = document.getElementById("feedback-submit-button");
        const textareas = document.querySelectorAll('.feedback-textarea-container');

        // Show form based on selection
        [posBtn, negBtn].forEach(btn => {
            btn.addEventListener("click", () => {
                feedbackInit.style.opacity = "0";
                feedbackInit.addEventListener("transitionend", () => {
                    feedbackInit.remove();
                    if (btn.id === "posBtn") {
                        feedbackFormPos.classList.remove("d-none");
                    } else {
                        feedbackFormNeg.classList.remove("d-none");
                    }
                    feedbackSubmitContainer.classList.remove("d-none");
                }, { once: true });
            });
        });

        // Add textarea when a radio is selected
        document.querySelectorAll('input[name="feedback"]').forEach(radio => {
            radio.addEventListener("change", () => {
                // Clear all textareas
                textareas.forEach(container => {
                    container.innerHTML = "";
                });

                const parentID = radio.id;
                const container = document.getElementById(parentID + "TextContainer");
                container.innerHTML = `
            <textarea cols="55" maxlength="500" rows="3"
                      placeholder="(Optional) Try to be as specific and detailed as possible!"
                      class="feedback-textarea p-2 mb-2"></textarea>
          `;

                feedbackSubmitBtn.removeAttribute("disabled");
            });
        });

        // Submit feedback
        feedbackSubmitBtn.addEventListener("click", () => {
            const form = document.querySelector('.feedback-form:not(.d-none)');
            const formType = form?.getAttribute("data-type");
            const rating = form?.querySelector('input[name="feedback"]:checked')?.value;
            const message = form?.querySelector("#textarea")?.value || "";
            const resultEl = document.getElementById("feedback-end");

            function onSuccess() {
                form.remove();
                feedbackSubmitContainer.remove();
                resultEl.innerHTML = `{{ .Site.Params.feedback.successMsg | default "Thank you for helping to improve our documentation!" }}`;
                resultEl.classList.add("is-visible", "text-success", "fw-bold");
            }

            try {
                if (formType === "positive") {
                    { { if .Site.Config.Services.GoogleAnalytics.ID } }
                    { { if not.Site.Params.feedback.eventDest | or(in .Site.Params.feedback.eventDest "google") } }
                    gtag("event", "{{ .Site.Params.feedback.positiveEventName | default "Positive Feedback" | lower | replaceRE `( +)` "_" }}", {
                        rating,
                        message,
                        event_callback: onSuccess
                    });
                    { { end } }
                    { { end } }

                    { { if .Site.Params.plausible.dataDomain } }
                    { { if not.Site.Params.feedback.eventDest | or(in .Site.Params.feedback.eventDest "plausible") } }
                    plausible("{{ .Site.Params.feedback.positiveEventName | default "Positive Feedback" }}", {
                        callback: onSuccess,
                        props: { rating, message }
                    });
                    { { end } }
                    { { end } }
                }

                if (formType === "negative") {
                    { { if .Site.Config.Services.GoogleAnalytics.ID } }
                    { { if not.Site.Params.feedback.eventDest | or(in .Site.Params.feedback.eventDest "google") } }
                    gtag("event", "{{ .Site.Params.feedback.negativeEventName | default "Negative Feedback" | lower | replaceRE `( +)` "_" }}", {
                        rating,
                        message,
                        event_callback: onSuccess
                    });
                    { { end } }
                    { { end } }

                    { { if .Site.Params.plausible.dataDomain } }
                    { { if not.Site.Params.feedback.eventDest | or(in .Site.Params.feedback.eventDest "plausible") } }
                    plausible("{{ .Site.Params.feedback.negativeEventName | default "Negative Feedback" }}", {
                        callback: onSuccess,
                        props: { rating, message }
                    });
                    { { end } }
                    { { end } }
                }

                // Fallback
                if (!window.gtag && !window.plausible) {
                    console.log("No analytics. Simulating success.");
                    onSuccess();
                }
            } catch (err) {
                console.error("Feedback submission error:", err);
                form.remove();
                feedbackSubmitContainer.remove();
                resultEl.innerHTML = `{{ .Site.Params.feedback.errorMsg | default "Sorry! There was an error submitting your feedback." }}`;
                resultEl.classList.add("is-visible", "text-danger", "fw-bold");
            }
        });
    });
</script>
{{ end }}